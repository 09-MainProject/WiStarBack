----------
WiStar
----------

ì•„ì´ëŒ ìŠ¤ì¼€ì¥´ ê´€ë¦¬ ìº˜ë¦°ë” ì„œë¹„ìŠ¤

1íŒ€ ë°±ì—”ë“œ : ì •ì˜í•˜, ëª…ë³´ê²½, ê¹€íƒœì§„, ê³ ê·¼ìš°
1íŒ€ í”„ë¡ íŠ¸ : ê¹€ì¢…ì—½, ì´ê´€ìš©, ë°•ì§„í˜¸

9ê¸° ë©”ì¸í”„ë¡œì íŠ¸
[https://legend-palm-1f1.notion.site/9-1d5caf5650aa80dea77ddd4351094fe7

ë©”ì¸ í”„ë¡œì íŠ¸ íŒ€ ë¹Œë”© / íŒ€ ë³„ ê³µê°„
[https://legend-palm-1f1.notion.site/1d5caf5650aa81cfaa04c343cf459b57

ë©”ì¸ í”„ë¡œì íŠ¸ ê°œì¸ ë³„ ê³µê°„
[https://legend-palm-1f1.notion.site/1d5caf5650aa81d4a026f7fb8a4fdb8c

í”„ë¡œì íŠ¸ í…œí”Œë¦¿
[https://legend-palm-1f1.notion.site/1d8caf5650aa80d4be63e9be6914d07f

ì£¼ì œ ì„ ì •
[https://www.notion.so/1d5caf5650aa814a8b11e1cfb7b153d6

íŠ¸ëŸ¬ë¸”ìŠˆíŒ… í…œí”Œë¦¿
[https://www.notion.so/1d5caf5650aa811d8299e5f53a64d2af

í”„ë¡œì íŠ¸ êµ¬ì¡°
project_name/
â”œâ”€â”€ .github/                # ê¹ƒí—ˆë¸Œ ì„¤ì • íŒŒì¼ ( ì»¤ë°‹í…œí”Œë¦¿, ì´ìŠˆí…œí”Œë¦¿, pr í…œí”Œë¦¿, CI / CD ë“± )
â”‚   â”œâ”€â”€ COMMIT_TEMPLATE/    # í•˜ìœ„ì— ì»¤ë°‹ í…œí”Œë¦¿ì„ ì •ì˜
â”‚   â”œâ”€â”€ ISSUE_TEMPLATE/     # í•˜ìœ„ì— ì´ìŠˆí…œí”Œë¦¿ì„ ì •ì˜
â”‚   â””â”€â”€ workflows/          # í•˜ìœ„ì— CI / CD ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì •ì˜
â”‚       â”œâ”€â”€ checks.yml     # develop ë˜ëŠ” main ë¸Œëœì¹˜ì— Push ë˜ëŠ” PR Merge ì‹œ ë°ì´í„° ë² ì´ìŠ¤ ì—°ê²° í™•ì¸, ì½”ë“œ í¬ë§¤íŒ… ì²´í¬, í…ŒìŠ¤íŠ¸ í†µê³¼ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
â”‚       â””â”€â”€ deploy.yml     # develop ë˜ëŠ” main ë¸Œëœì¹˜ì— Push ë˜ëŠ” Mergeì‹œ ë°°í¬ ìë™í™”ë¥¼ êµ¬í˜„í•œ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ config/                 # í”„ë¡œì íŠ¸ ì„¤ì • íŒŒì¼ (settings, urls ë“±)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ asgi.py
â”‚   â”œâ”€â”€ settings.py
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ wsgi.py
â”œâ”€â”€ apps/                   # ì•± ë””ë ‰í† ë¦¬ (ì•±ë³„ë¡œ ë””ë ‰í† ë¦¬ë¥¼ ë‚˜ëˆ”)
â”‚   â”œâ”€â”€ app_name1/
â”‚   â”‚   â”œâ”€â”€ migrations/     # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
â”‚   â”‚   â”œâ”€â”€ services/       # ì•±ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì„œë¹„ìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ëŠ” í´ë”
â”‚   â”‚   â”œâ”€â”€ repository/     # ì•±ì˜ ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ì— ê´€ë ¨ëœ CRUD ë™ì‘ì„ ì •ì˜í•˜ëŠ” í´ë”
â”‚   â”‚   â”œâ”€â”€ admin.py        # Django Admin ê´€ë ¨ ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ apps.py         # ì•± ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ models.py       # ëª¨ë¸ ì •ì˜
â”‚   â”‚   â”œâ”€â”€ tests.py        # í…ŒìŠ¤íŠ¸ ì½”ë“œ
â”‚   â”‚   â”œâ”€â”€ urls.py         # ì•± ì „ìš© URL ë¼ìš°íŒ…
â”‚   â”‚   â””â”€â”€ views.py        # ë·° ë¡œì§
â”‚   â”œâ”€â”€ app_name2/          # ë‹¤ë¥¸ ì•±
â”‚   â”‚   â”œâ”€â”€ migrations/     # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
â”‚   â”‚   â”œâ”€â”€ services/       # ì•±ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì„œë¹„ìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ëŠ” í´ë”
â”‚   â”‚   â”œâ”€â”€ repository/     # ì•±ì˜ ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ì— ê´€ë ¨ëœ CRUD ë™ì‘ì„ ì •ì˜í•˜ëŠ” í´ë”
â”‚   â”‚   â”œâ”€â”€ admin.py        # Django Admin ê´€ë ¨ ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ apps.py         # ì•± ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ models.py       # ëª¨ë¸ ì •ì˜
â”‚   â”‚   â”œâ”€â”€ tests.py        # í…ŒìŠ¤íŠ¸ ì½”ë“œ
â”‚   â”‚   â”œâ”€â”€ urls.py         # ì•± ì „ìš© URL ë¼ìš°íŒ…
â”‚   â”‚   â””â”€â”€ views.py        # ë·° ë¡œì§
â”‚   â””â”€â”€ ...
â”œâ”€â”€ envs/                   # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ë“¤
â”‚   â”œâ”€â”€ .env.local          # ë¡œì»¬ í™˜ê²½ì—ì„œ ì„œë²„ êµ¬ë™ ë° í…ŒìŠ¤íŠ¸ ì‹œ í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜
â”‚   â””â”€â”€ .env.prod           # ë°°í¬ í™˜ê²½ì—ì„œ ì„œë²„ êµ¬ë™ ë° í…ŒìŠ¤íŠ¸ ì‹œ í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜
â”œâ”€â”€ resources/              # ì´ˆê¸° ì„¤ì • íŒŒì¼ ë° ìŠ¤í¬ë¦½íŠ¸, nginx, docker, kubernetes ì˜ yaml íŒŒì¼
â”‚   â”œâ”€â”€ nginx/
â”‚   â”‚   â””â”€â”€ nginx.conf      # ëª¨ë¸ ì •ì˜
â”‚   â”œâ”€â”€ docker/
â”‚   â”‚   â”œâ”€â”€ dockerfile      # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ íŒŒì¼
â”‚   â”‚   â””â”€â”€ docker-compose.yml   # ë„ì»¤ ì»¨í…Œì´ë„ˆ ì •ì˜ íŒŒì¼
â”‚   â”œâ”€â”€ kubernetes/
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ entrypoint.sh   # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì‹œ ìµœì¢…ì ìœ¼ë¡œ ì‹¤í–‰ë  ìŠ¤í¬ë¦½íŠ¸ ( ì¼ë°˜ì ìœ¼ë¡œ ì„œë²„ ì‹¤í–‰ ëª…ë ¹ )
â”‚       â””â”€â”€ test.sh         # ì½”ë“œ í¬ë§¤íŒ… ë° í…ŒìŠ¤íŠ¸ì½”ë“œ ì‹¤í–‰ ì‹œ ì‚¬ìš©ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ manage.py               # ê´€ë¦¬ ëª…ë ¹ì–´
â”œâ”€â”€ poetry.lock             # poetry ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì •ë³´
â””â”€â”€ pyproject.toml          # poetry ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ëª©ë¡ ë° ì„¤ì •


poetry ì´ˆê¸°í™”
poetry init

poetryë¡œ ìƒì„±ëœ ê°€ìƒí™˜ê²½ ê²½ë¡œ í™•ì¸
poetry env info --path
ê²½ë¡œ í™•ì¸ í›„ ì¸í„°í”„ë¦¬í„° ì„¤ì •

ê°€ìƒí™˜ê²½ í„°ë¯¸ë„ì— í™œì„±í™” (ì•ˆí•´ë„ë¨)
poetry env activate
ë°˜í™˜ ë˜ëŠ” ê°’ ë³µì‚¬í•´ì„œ ë‹¤ì‹œ ì‹¤í–‰

ì „ì²´ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ê°œë°œìš© í¬í•¨)
poetry install

ë°°í¬ìš© íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜ (dev ì œì™¸)
poetry install --no-dev
ì•ˆë ì‹œ
poetry install --no-root

ë¼ì´ë¸ŒëŸ¬ë¦¬ ì œê±°
poetry remove ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„

[tool.poetry.dependencies] ì—ëŠ” ë°°í¬ í™˜ê²½ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜
poetry add ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„

[tool.poetry.group.dev.dependencies] ì— ê°œë°œí™˜ê²½ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
poetry add -G dev ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„
ë˜ëŠ”
poetry add --group=dev ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„


docker-composeë¥¼ ì‚¬ìš©í•´ PostgreSQL DBìƒì„±

postgres ì…‹íŒ…
docker-compose-local.yml ìƒì„±

PostgreSQL ì´ë¯¸ì§€ ìƒì„± ë° ì‹¤í–‰
docker-compose -f resources/docker/docker-compose-local.yml up -d

ì‹¤í–‰ ì¤‘ì¸ ë„ì»¤ ì´ë¯¸ì§€ í™•ì¸ (ì´ë¯¸ì§€ id í™•ì¸ ê°€ëŠ¥)
docker ps

í™˜ê²½ ë³€ìˆ˜ ì±„í¬
docker exec myfavidol_db printenv | grep POSTGRES

ë„ì»¤ ì»¨í…Œì´ë„ˆ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì†
docker exec -it myfavidol_db psql -U postgres -d oz_project

ë„ì»¤ ì´ë¯¸ì§€ ì¤‘ì§€
docker stop ì´ë¯¸ì§€id

íŒ€ì›ì´ í•´ì•¼í•  ì¼

ê¹ƒ í´ë¡ 
git clone https://github.com/09-MainProject/MyFavIdolBack.git

pyenvë¡œ íŒŒì´ì¬ 3.13.1ë²„ì „ ì„¤ì¹˜
pyenv install 3.13.1

poetryê°€ ìƒì„±í•œ pyproject.tomlì— ì‘ì„±ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë° ì´ˆê¸°í™”
ì „ì²´ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ê°œë°œìš© í¬í•¨)
poetry install --no-root

git config ìë™ ì„¤ì •
ì‹¤í–‰ ê¶Œí•  ì„¤ì •
chmod +x resources/scripts/setup.sh
setup.sh ì‹¤í–‰
resources/scripts/setup.sh

ê°€ìƒí™˜ê²½ ì—†ìœ¼ë©´ ê°€ìƒí™˜ê²½ì„ ìë™ìƒì„±í•¨. ê¸°ë³¸ì„¤ì • : ì „ì—­ìœ„ì¹˜ì— ê°€ìƒí™”ê²½ ìƒì„±
í˜¹ì€ ê°€ìƒí™˜ê²½ì„ ë¯¸ë¦¬ ë§Œë“  ìƒíƒœì—ì„  ê°€ìƒí™˜ê²½ì— ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜

ì „ì—­ ê°€ìƒí™˜ê²½ ìœ„ì¹˜ í™•ì¸
poetry env info --path

ì „ì—­ ê°€ìƒí™˜ê²½ ì œê±°
poetry env remove python

ê°€ìƒí™˜ê²½ ìƒì„±
python3 -m venv .venv

ì„¤ì • íŒŒì¼ ìƒì„±
django-admin startproject config .

ì•± ë§Œë“¤ê¸°
python3 manage.py startapp ì•±ì´ë¦„

í•˜ìœ„ í´ë”ì— ì•± ë§Œë“¤ê¸° (ë§Œë“¤ì–´ì§ˆ ì•±ì´ë¦„ì˜ í´ë”ê°€ ê²½ë¡œì— ìˆì–´ì•¼í•¨)
python3 manage.py startapp ì•±ì´ë¦„ ê²½ë¡œ

postgresql db ì„¤ì¹˜
brew install postgresql

PostgreSQL ì„œë²„ ì‹¤í–‰
brew services start postgresql

ì‹¤í–‰ í™•ì¸
brew services

PostgreSQL ì„¤ì¹˜ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì¸ postgresì— ì ‘ì†
psql postgres

ìœ ì € í™•ì¸
ë³¸ì¸ì˜ ë§¥ ìœ ì € ì´ë¦„ í˜¹ì€ postgresë¼ëŠ” ìœ ì €ê°€ ìˆì–´ì•¼ ì •ìƒ
\du

ìƒˆë¡œìš´ ìœ ì €ë¥¼ ìƒì„±
CREATE USER ìœ ì €ì´ë¦„

ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
ALTER USER root WITH PASSWORD 'ë¹„ë°€ë²ˆí˜¸';

ê¶Œí•œ ì„¤ì •
ALTER USER root WITH SUPERUSER;

ìœ ì € ë‹¤ì‹œ í™•ì¸
\du

db ìƒì„±
CREATE DATABASE ë°ì´í„°ë² ì´ìŠ¤ì´ë¦„;

db ëª©ë¡ í™•ì¸
\l


ìƒˆë¡œ ìƒì„±ëœ ìœ ì € í˜¹ì€ ê¸°ë³¸ ìœ ì €ë¥¼ í™œìš©í•˜ì—¬ ìƒì„±ëœ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì ‘ì†
psql ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
ë˜ëŠ”
psql -U ìœ ì €ì´ë¦„ -d ë°ì´í„°ë² ì´ìŠ¤ì´ë¦„ -W
(Wì˜µì…˜ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ì ‘ì†í•˜ëŠ” ê²ƒ ì…ë‹ˆë‹¤. í•„ìˆ˜ëŠ” ì•„ë‹˜)

í…Œì´ë¸” ë‚´ì—­ì„ ì¡°íšŒ
\dt

PostgreSQLì„ Djangoì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ í•„ìš”í•œ psycopg ì„¤ì¹˜
poetry add psycopg2-binary


- í”„ë¡œì íŠ¸ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬í•´ì•¼í•˜ëŠ” ê²ƒ
    - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´
    - AWS ë˜ëŠ” NCP ë“±ì˜ í´ë¼ìš°ë“œ ì—°ê²° ì •ë³´
    - ì†Œì…œ ë¡œê·¸ì¸ Client ID, Client Secret, Redirect URI
    - ì™¸ë¶€ API ì¸ì¦ ì •ë³´
    - í”„ë¡œì íŠ¸ ì‹œí¬ë¦¿ í‚¤ ( ë§¤ìš° ì¤‘ìš” ! )


- CI / CD ì„¤ì •

--------
# Black
--------

blackì´ë€?
"The uncompromising Python code formatter"
(íƒ€í˜‘ ì—†ëŠ”, ì—„ê²©í•œ Python ì½”ë“œ í¬ë§¤í„°)

ğŸ”§ ë¬´ìŠ¨ ì—­í• ì„ í•˜ë‚˜ìš”?
Python ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì •í•´ì§„ ìŠ¤íƒ€ì¼ëŒ€ë¡œ ì •ë¦¬í•´ì¤ë‹ˆë‹¤.

ê°œë°œìê°€ ì½”ë“œ ìŠ¤íƒ€ì¼ë¡œ ê³ ë¯¼í•˜ì§€ ì•Šë„ë¡ ê°•ë ¥í•œ ê·œì¹™ì„ ì ìš©í•©ë‹ˆë‹¤.

ì‚¬ëŒë§ˆë‹¤ ìŠ¤íƒ€ì¼ì´ ë‹¤ë¥¸ ê±¸ ë°©ì§€ â†’ íŒ€ í”„ë¡œì íŠ¸ì— íŠ¹íˆ ìœ ë¦¬

ë¸”ë™(black) ì„¤ì¹˜
poetry add --group=dev black

ë¸”ë™ ì‹¤í–‰
black .  ë˜ëŠ”  poetry run black .

Black	# fmt: off/on	í¬ë§¤íŒ… ì˜ˆì™¸ ì²˜ë¦¬ êµ¬ê°„ ì„¤ì •

----------
isort
----------

isortë€?
import ì •ë¦¬ ë„êµ¬: íŒŒì´ì¬ íŒŒì¼ ë‚´ì˜ import êµ¬ë¬¸ì„ ì•ŒíŒŒë²³ ìˆœì„œë¡œ ì •ë ¬í•˜ê³ , í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬, ì„œë“œíŒŒí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬, ë¡œì»¬ ëª¨ë“ˆì„ êµ¬ë¶„í•´ì„œ ê¹”ë”í•˜ê²Œ ì •ë ¬í•´ì¤ë‹ˆë‹¤.
í˜‘ì—… ì‹œ ì½”ë“œ ìŠ¤íƒ€ì¼ì„ í†µì¼í•˜ê³  ê°€ë…ì„±ì„ ë†’ì—¬ì¤ë‹ˆë‹¤.
Black, Flake8, Ruff ë“± ë‹¤ë¥¸ í¬ë§·í„°ë‚˜ ë¦°í„°ì™€ í•¨ê»˜ ìì£¼ ì‚¬ìš©ë©ë‹ˆë‹¤.

isort your_file.py   ë‹¨ì¼ íŒŒì¼ ì •ë ¬
isort .  í”„ë¡œì íŠ¸ ì „ì²´ ì •ë ¬
isort . --check   ê²€ì‚¬ë§Œ í•˜ê³  ìˆ˜ì •í•˜ì§€ ì•Šê¸° (CI ìš©ë„)

isort	# isort: skip	í•´ë‹¹ ì¤„ import ì •ë ¬ ì œì™¸
isort	# isort: off/on	êµ¬ê°„ ë‹¨ìœ„ import ì •ë ¬ ì œì™¸

----------
# Mypy
----------

mypyë€?
ì •ì  íƒ€ì… ê²€ì‚¬(static type checking)**ë¥¼ í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬
mypyëŠ” Python ì½”ë“œì— ì‘ì„±ëœ **íƒ€ì… íŒíŠ¸(type hint)**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì½”ë“œ ì‹¤í–‰ ì—†ì´ íƒ€ì… ì˜¤ë¥˜ë¥¼ ì‚¬ì „ì— ì°¾ì•„ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
Pythonì€ ê¸°ë³¸ì ìœ¼ë¡œ ë™ì  íƒ€ì… ì–¸ì–´ì´ì§€ë§Œ, íƒ€ì… íŒíŠ¸ë¥¼ í™œìš©í•˜ë©´ ì •ì  íƒ€ì…ì²˜ëŸ¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
íƒ€ì… ê´€ë ¨ ë²„ê·¸ë¥¼ ì¤„ì´ê³ , ì½”ë“œì˜ ì•ˆì •ì„±ê³¼ ê°€ë…ì„±ì„ ë†’ì´ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.


Mypy ì„¤ì¹˜
poetry add --group=dev mypy

mypyë¡œ ê²€ì‚¬
mypy .


# type: ignore	í•´ë‹¹ ë¼ì¸ ëª¨ë“  íƒ€ì… ì—ëŸ¬ ë¬´ì‹œ
# type: ignore[ì—ëŸ¬ì½”ë“œ]	íŠ¹ì • íƒ€ì… ì—ëŸ¬ë§Œ ë¬´ì‹œ
# mypy: ignore-errors	íŒŒì¼ ì „ì²´ íƒ€ì… ê²€ì‚¬ ë¬´ì‹œ
# mypy: disable-error-code	íŒŒì¼ ë‹¨ìœ„ íŠ¹ì • ì—ëŸ¬ì½”ë“œ ë¬´ì‹œ
# type:	ë³€ìˆ˜ì— íƒ€ì… ì£¼ì„ ì§€ì •

-----------
# Pytest
-----------

- pytestëŠ” íŒŒì´ì¬ì—ì„œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‰½ê²Œ ì‘ì„±í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬

pytest ì„¤ì¹˜
poetry add --group=dev pytest

# pytest ì‚¬ìš©ì‹œ
# í•¨ìˆ˜ ì´ë¦„ ì•ì— test_ë¼ê³  ì¨ì£¼ë©´ test í•¨ìˆ˜ì¸ê±¸ ì¸ì‹í•œë‹¤.

# íŒŒì´ì°¸ì—ì„œ pytest í•¨ìˆ˜ë¥¼ ë§Œë“¤ë©´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ë²„íŠ¼ì´ ìƒê¸´ë‹¤.
# í„°ë¯¸ë„ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ pytest . ì´ë ‡ê²Œ ì…ë ¥í•˜ë©´ ë¨.
def test_simple() -> None:
    print("Testing simple")



poetry add --group=dev isort
ê²€ì‚¬
isort .

# isortê°€ í•´ë‹¹ import ì •ë ¬í•˜ì§€ ì•ŠìŒ
# isort: skip

í•´ë‹¹ ì—ëŸ¬ì½”ë“œ ë¬´ì‹œ ì„¤ì •
# noqa: ì—ëŸ¬ì½”ë“œ
# noqa: F405
# noqa: F403

í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
./resources/scripts/test.sh  ìƒì„±

ê¶Œí•œ ì„¤ì •
chmod +x ./resources/scripts/test.sh

ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./resources/scripts/test.sh


# ymlì€ íƒ­ì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
# yml ê²€ì‚¬ ì‚¬ì´íŠ¸
# https://www.yamllint.com/


ê¹ƒ í”Œë¡œìš°
https://legend-palm-1f1.notion.site/Git-Flow-14acaf5650aa800387a7c43e334cc72e
https://legend-palm-1f1.notion.site/Git-Flow-14acaf5650aa80f2a4a9efa455e54f9b

ë§¥ì—ì„œ í™ˆë¸Œë£¨ë¡œ ê¹ƒ í”Œë¡œìš° ì„¤ì¹˜
brew install git-flow-avh

ê¹ƒ í”Œë¡œìš° ì´ˆê¸°í™”
git flow init

Branch name for production releases?
â†’ ê¸°ë³¸ê°’ì€ master ì´ì§€ë§Œ main ìœ¼ë¡œ í•˜ëŠ”ê²ƒ ì¶”ì²œ

Branch name for "next release" development?
â†’ develop (ê¸°ë³¸ê°’)

ë‚˜ë¨¸ì§€ ì—”í„°

git push origin develop

ì´í›„ íŒ€ì› ì„¤ì •
git fetch origin   ë˜ëŠ”  git fetch --all

ì›ê²© develop ë¸Œëœì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë¡œì»¬ develop ë¸Œëœì¹˜ ìƒì„±
git checkout -b develop origin/develop

# Feature ë¸Œëœì¹˜

ìƒì„±: ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ê°œë°œí•  ë•Œ ì‚¬ìš©
git flow feature start <ê¸°ëŠ¥ì´ë¦„>

ì™„ë£Œ: ê¸°ëŠ¥ ê°œë°œì„ ë§ˆì¹˜ê³  develop ë¸Œëœì¹˜ë¡œ ë³‘í•©
git flow feature finish <ê¸°ëŠ¥ì´ë¦„>

# Release ë¸Œëœì¹˜

ìƒì„±: ë°°í¬ ì¤€ë¹„ë¥¼ í•  ë•Œ ì‚¬ìš©
git flow release start <ë²„ì „ë²ˆí˜¸>

ì™„ë£Œ: ë¦´ë¦¬ì¦ˆ ì™„ë£Œ í›„ masterì™€ developì— ë³‘í•©
git flow release finish <ë²„ì „ë²ˆí˜¸>

# Hotfix ë¸Œëœì¹˜

ìƒì„±: ê¸´ê¸‰í•œ ë²„ê·¸ ìˆ˜ì •ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©
git flow hotfix start <ë²„ê·¸ì´ë¦„>

ì™„ë£Œ: ìˆ˜ì • ì™„ë£Œ í›„ masterì™€ developì— ë³‘í•©
git flow hotfix finish <ë²„ê·¸ì´ë¦„>


## . Git Flow ì „ì²´ íë¦„

1. íŒ€ ë¦¬ë”ê°€ new project ìƒì„±í•˜ê³  ì´ˆê¸° ì„¸íŒ…ì„ ì§„í–‰
2. íŒ€ ë¦¬ë”ê°€ github repositoryì— ì˜¬ë¦¬ê¸°
3. ë‚˜ë¨¸ì§€ íŒ€ì›ë“¤ì€ repositoryì— ì˜¬ë¼ ì˜¨ projectë¥¼ í´ë¡ ë°›ì•„ ë¡œì»¬ì— ê°€ì ¸ì˜´
4. ì „ íŒ€ì› `git flow init` (ì´ˆê¸°í™”) í•´ì¤Œ
    - ì´ˆê¸°í™” ì‹œ `Branch name for production releases?`ì§ˆë¬¸ì—
    â†’ ê¸°ë³¸ ê°’ì€ `master` ì´ì§€ë§Œ `main` ìœ¼ë¡œ ì„¤ì •í•˜ì‹œëŠ” ê²ƒì„ ì¶”ì²œ..
5. ëª¨ë“  íŒ€ì› ë¡œì»¬ í™˜ê²½ì—ì„œ `git branch` ëª…ë ¹ì–´ë¡œ ì¡´ì¬í•˜ëŠ” ë¸Œëœì¹˜ë¥¼ í™•ì¸í•´ë³´ë©´ ì²˜ìŒì—ëŠ” `main` ë¸Œëœì¹˜ ë¿ë§Œ ìˆì—ˆì§€ë§Œ ì´ˆê¸°í™” ì´í›„  `develop` ë¸Œëœì¹˜ê°€ ë¡œì»¬ì— ìƒê²¨ìˆìŒì„ í™•ì¸ê°€ëŠ¥.
6. ê°ì ë§¡ì€ ê¸°ëŠ¥ ê°œë°œì„ ìœ„í•´ `git flow feature start ê¸°ëŠ¥ì´ë¦„` ëª…ë ¹ì–´ë¡œ feature ë¸Œëœì¹˜ë¥¼ ìƒì„±
â†’ `git branch` ëª…ë ¹ì–´ë¡œ í™•ì¸í•´ë³´ë©´ `feature/ê¸°ëŠ¥ì´ë¦„` ë¸Œëœì¹˜ê°€ ìƒì„±ë˜ì–´ìˆìŒ.
7. ìƒì„±ëœ feature ë¸Œëœì¹˜ì—ì„œ ê¸°ëŠ¥ ê°œë°œ ì‘ì—…í•©ë‹ˆë‹¤.
8. ì‘ì—… ì™„ë£Œ í›„ feature ë¸Œëœì¹˜ë¥¼ ì›ê²© ì €ì¥ì†Œì— push í•´ì„œ PR ì˜¬ë¦½ë‹ˆë‹¤.
9. PR íƒ€ì´í‹€, ì„¤ëª… ë“± ì‘ì„± í›„ ë¦¬ë·°ì–´ íŒ€ì›ë“¤ ë“±ë¡í•©ë‹ˆë‹¤.
10. PR ìŠ¹ì¸ ë˜ë©´ Squash and Merge ë²„íŠ¼ì„ í†µí•´ ì••ì¶• ëœ í•˜ë‚˜ì˜ ì»¤ë°‹ìœ¼ë¡œ developì— ë¨¸ì§€í•©ë‹ˆë‹¤.
11. ê·¸ë¦¬ê³  ë¡œì»¬ í™˜ê²½ì—ì„œ `develop` ë¸Œëœì¹˜ë¡œ checkout í•˜ê³ , ê¸°ëŠ¥ ê°œë°œì‹œì— ì‚¬ìš©í–ˆë˜ ê¸°ì¡´ì˜  feature ë¸Œëœì¹˜ëŠ” ì‚­ì œí•´ì¤ë‹ˆë‹¤.
12. ê°œë°œëœ ê¸°ëŠ¥ì´ ì—…ë°ì´íŠ¸ ëœ ì›ê²© ì €ì¥ì†Œì˜ `develop` ë¸Œëœì¹˜ë¥¼ `pull` í•©ë‹ˆë‹¤.
    - `git pull origin develop` ëª…ë ¹ì–´ ì‚¬ìš©í•˜ê¸°
13. (( 7~13ë²ˆ ë¬´í•œ ë°˜ë³µ ))
14. ê° íŒ€ì›ë“¤ì´ ê¸°ëŠ¥ ê°œë°œì„ ëª¨ë‘ ì™„ë£Œí–ˆë‹¤ë©´ ë°°í¬í•  ì¤€ë¹„ë¥¼ í•´ì•¼í•©ë‹ˆë‹¤. íŒ€ì¥ì´ ë°°í¬ ê´€ë ¨ ì„¤ì •ì„ ëª¨ë‘ ì™„ë£Œí•˜ê³  `develop` ë¸Œëœì¹˜ì— ë¨¸ì§€í•©ë‹ˆë‹¤.
15. `main` ë¸Œëœì¹˜ì™€ `develop` ë¸Œëœì¹˜ë¥¼ compare & PR í•œ í›„ `merge` í•©ë‹ˆë‹¤.
16. `main` ë¸Œëœì¹˜ë¥¼ EC2 ì—ì„œ í´ë¡ ë°›ì•„ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.


.gitignore ì‹œí¬ë¦¿ í´ë” ì—…ë¡œë“œ ì œí•œ
.config_secret/

ì‹œí¬ë¦¿ í´ë” ìƒì„±
.config_secret

ì‹œí¬ë¦¿ í´ë”ì— secret.json ìƒì„±

secret.jsonì— ì…ë ¥
{
  "DJANGO_SECRET_KEY" : "django-insecure-9u=$gmlz$b8h2^d9%3x871ti9pcile_q19lif*#yw(q@#=nb!8",
  "email": {
    "user": "ì´ë©”ì¼",
    "password": "ë¹„ë°€ë²ˆí˜¸"
  },
  "DB": {
  "ENGINE": "django.db.backends.postgresql",
  "NAME": "bank",
  "USER": "root",
  "PASSWORD": "1234",
  "HOST": "localhost",
  "PORT": "5432"
  }
}

ì‹œí¬ë¦¿ íŒŒì¼ ì½ì–´ ì˜¤ê¸° ìœ„í•´ settings.pyì— ì„¤ì •

with open(BASE_DIR / '.config_secret' / 'secret.json') as f:
    config_secret_str = f.read()

SECRET = json.loads(config_secret_str)  # json í˜•íƒœë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë°”ê¿ˆ

# Email
# from django.core.mail.backends.smtp import EmailBackend
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.naver.com' # ë„¤ì´ë²„ í™˜ê²°ì„¤ì •ì—ì„œ ë³¼ ìˆ˜ ìˆìŒ.
EMAIL_USE_TLS = True  # ë³´ì•ˆì—°ê²°
EMAIL_PORT = 587  # ë„¤ì´ë²„ ë©”ì¼ í™˜ê²½ì„¤ì •ì—ì„œ í™•ì¸ ê°€ëŠ¥
EMAIL_HOST_USER = SECRET["email"]["user"]
EMAIL_HOST_PASSWORD =  SECRET["email"]["password"]

# .config_secret í´ë” ë§Œë“¤ê³ 
# í´ë”ì— secret.json ë§Œë“¤ê³ 
# .gitignoreì— ì¶”ê°€í•œ í›„ ê´€ë¦¬
# print(SECRET['DB']['HOST'])
# print(SECRET['DB2']['HOST'])
# ì´ë ‡ê²Œ ì“¸ ìˆ˜ë„ìˆê³  dotenvë¥¼ í†µí•´ ê´€ë¦¬í•  ìˆ˜ë„ ìˆìŒ

LOGIN_URL = '/login/'
LOGOUT_REDIRECT_URL = '/login/'
# LOGOUT_REDIRECT_URL = '/'



simplejwt ì‹œì‘
https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html

simplejwt ì„¤ì¹˜
poetry add djangorestframework-simplejwt

# config/settings.py

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        ...
        'rest_framework_simplejwt.authentication.JWTAuthentication',
        ...
    ]
}
INSTALLED_APPS = [
    ...
    'rest_framework_simplejwt',
    ...
]

# config/urls.py

urlpatterns = [
    ...
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('api/token/verify/', TokenVerifyView.as_view(), name='token_verify'),
    ...
]

simplejwt ì„¸íŒ…
https://django-rest-framework-simplejwt.readthedocs.io/en/latest/settings.html#


simplejwt ì»¤ìŠ¤í„° ë§ˆì´ì§•
https://django-rest-framework-simplejwt.readthedocs.io/en/latest/customizing_token_claims.html

# utils/jwt_serializers.py

from rest_framework_simplejwt.serializers import TokenObtainPairSerializer
from rest_framework_simplejwt.views import TokenObtainPairView

class MyTokenObtainPairSerializer(TokenObtainPairSerializer):
    @classmethod
    def get_token(cls, user):
        token = super().get_token(user)

        # Add custom claims
        token['user_name'] = user.username  # í† í°ì— ìœ ì € ì´ë¦„ì„ í•¨ê»˜ ë‹´ì•„ì„œ ë³´ëƒ„

        return token

# config/settings.py
# JWT ì„¤ì •
SIMPLE_JWT = {
  # It will work instead of the default serializer(TokenObtainPairSerializer).
  "TOKEN_OBTAIN_SERIALIZER": "utils.jwt_serializers.MyTokenObtainPairSerializer",
  # ...
}

í† í° ì •ë³´ ë³´ëŠ” ë²•
https://jwt.io/

í† í° ë§Œë£Œì‹œê°„ ìˆ˜ì •
# JWT ì„¤ì •
SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(minutes=30),
    "REFRESH_TOKEN_LIFETIME": timedelta(days=1),
    # It will work instead of the default serializer(TokenObtainPairSerializer).
    "TOKEN_OBTAIN_SERIALIZER": "utils.jwt_serializers.MyTokenObtainPairSerializer",
    # ...
}

poetry add -G dev django-extensions
poetry add -G dev ipython

poetry.lock ì—…ë°ì´íŠ¸
poetry lock


ê°œë°œí™˜ê²½ìœ¼ë¡œ ê°€ìƒí™˜ê²½ì— ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
poetry install --with dev --no-root

ë¡œê·¸ì•„ì›ƒ êµ¬í˜„
INSTALLED_APPS = [
    ...
    'rest_framework_simplejwt.token_blacklist',
]

# JWT ì„¤ì •
SIMPLE_JWT = {
    "BLACKLIST_AFTER_ROTATION": True,
    "ROTATE_REFRESH_TOKENS": True,
}

python manage.py migrate

ì—‘ì„¸ìŠ¤ í† í° (Access Token) ê´€ë¦¬

# 1.ì—‘ì„¸ìŠ¤ í† í° localStorageì— ì €ì¥ ë° ì‚­ì œ
// ë¡œê·¸ì¸ ì‹œ ì €ì¥
localStorage.setItem('access_token', accessToken);
// ë¡œê·¸ì•„ì›ƒ ì‹œ ì‚­ì œ
localStorage.removeItem('access_token');

sessionStorage ì‚¬ìš© ì‹œ
sessionStorage.removeItem('access_token');

React ìƒíƒœ ê´€ë¦¬ (Redux ë“±)	ìƒíƒœ ì´ˆê¸°í™”
dispatch({ type: 'LOGOUT' });  // í† í° ìƒíƒœ null ì²˜ë¦¬

ì„œë²„ì—ì„œ ì œì–´ (í”„ë¡ íŠ¸ì—ì„œ í† í°ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ)
HttpOnly Cookie	JSì—ì„œ ì‚­ì œ ë¶ˆê°€ â†’ ì„œë²„ì—ì„œ ì¿ í‚¤ ë§Œë£Œ ì²˜ë¦¬




----------------------
HttpOnly ì¿ í‚¤ì˜ í•µì‹¬ íŠ¹ì§•
----------------------

íŠ¹ì§•	ì„¤ëª…
JS ì ‘ê·¼ ë¶ˆê°€	document.cookieë¡œ ì½ê¸°/ì“°ê¸° ë¶ˆê°€
ìë™ ì „ì†¡	ê°™ì€ ë„ë©”ì¸ ìš”ì²­ ì‹œ ìë™ìœ¼ë¡œ í¬í•¨
ë³´ì•ˆ ê°•í™”	XSS ê³µê²©ìœ¼ë¡œë¶€í„° ì•ˆì „
ì‚­ì œ ë°©ë²•	ì˜¤ì§ ì„œë²„ê°€ ì¿ í‚¤ ë§Œë£Œ ì²˜ë¦¬ (Set-Cookieë¡œ)

final_response = Response(custom_response, status=status.HTTP_200_OK)
final_response.set_cookie(
    key='refresh_token',
    value=refresh_token,
    httponly=True,
    # secure=True,        # HTTPS í™˜ê²½ì—ì„œë§Œ ì „ì†¡
    secure=False,        # ë¡œì»¬ ê°œë°œ í™˜ê²½ì— ë§ì¶°ì„œ ì„¤ì •
    samesite='Lax',     # CSRF ê³µê²© ë°©ì§€ ì„¤ì •
    path='/api/token',  # í•„ìš”í•œ ê²½ë¡œì—ë§Œ ì¿ í‚¤ ì‚¬ìš©
    max_age=60 * 60 * 24 * 7,  # 7ì¼ (ì´ˆ ë‹¨ìœ„)
)
return final_response

settings.py ì„¤ì •
INSTALLED_APPS += ['corsheaders']

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',   # ìµœìƒë‹¨ì— ì¶”ê°€
    # ... ê¸°íƒ€ ë¯¸ë“¤ì›¨ì–´
]

# í”„ë¡ íŠ¸ ë„ë©”ì¸ ë“±ë¡
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
]

# ì¿ í‚¤ í¬í•¨ í—ˆìš©
CORS_ALLOW_CREDENTIALS = True


--------------------
ì´ë©”ì¼ ë³´ë‚´ëŠ” ê¸°ëŠ¥ ë¬¸ì œ
--------------------

DEBUG=Falseì¼ ë•Œ ì´ë©”ì¼ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì— ë¬¸ì œìƒê¸´ë‹¤ë©´.

from django.core.mail import send_mail
send_mail í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ë•Œ ë¬¸ì œê°€ ìƒê¸´ë‹¤ë©´

try:
    send_mail(subject, message, settings.EMAIL_HOST_USER, to_email)
except Exception as e:
    print(repr(e))
    raise

ì´ë ‡ê²Œ í•´ì„œ ì‹¤íŒ¨ í–ˆì„ ë•Œ ì›ì¸ì„ ì˜¤ë¥˜ ì½”ë“œë¡œ íŒŒì•…í•œë‹¤.

ì›ì¸ì€
SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self-signed certificate in certificate chain (_ssl.c:1018)')
ì¸ì¦ì„œë¥¼ ì°¾ì§€ ëª»í•´ì„œ ì˜¤ë¥˜ê°€ ë‚¬ë‹¤ëŠ” ë§ì¸ë°

íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ certifi ì„¤ì¹˜ í›„
ì¸ì¦ì„œë¥¼ ê°•ì œë¡œ ì¸ì‹ ê°€ëŠ¥í•˜ê²Œ certifië¡œ ì„¤ì •í•˜ë©´ ì–´ë– í•œ ê²½ìš°ì—ë„ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.
ì¸ì¦ì„œ ê²½ë¡œë¥¼ ì¸ì‹ëª»í•˜ë“  ì¸ì¦ì„œê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ì§€ ì•Šë“  ì¸ì‹.

í„°ë¯¸ë„ì— ì…ë ¥í•´ì„œ ì¼ì‹œì ìœ¼ë¡œ í•´ê²°í•˜ëŠ” ë°©ë²•
export SSL_CERT_FILE=$(python -m certifi)

í•´ê²°ë°©ë²•1
í„°ë¯¸ë„ì— ì˜êµ¬ ì ìš©

vim ~/.zshrc
ë§¨ ì•„ë« ì¤„ì— ì¶”ê°€
export SSL_CERT_FILE=$(python -m certifi)

í•´ê²°ë°©ë²•2
ê°€ìƒí™˜ê²½ì´ í™œì„±í™” ë ë•Œë§ˆë‹¤ ì¸ì¦ì„œ ê²½ë¡œë¥¼ ìë™ ì§€ì •í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•œë‹¤.

activateìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •
vim .venv/bin/activate
ë§¨ ì•„ë«ì¤„ì— ì¶”ê°€
export SSL_CERT_FILE=$(python -m certifi)

í•´ê²°ë°©ë²•3 (ê°€ì¥ ì¶”ì²œ)
í”„ë¡œì íŠ¸ê°€ ì¸ì¦ì„œ ê²½ë¡œë¥¼ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ ì¥ê³  í”„ë¡œì íŠ¸ì— ì„¤ì •

certifië¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìœ¼ë©´ ì„¤ì¹˜ í›„

settings.py ìµœìƒë‹¨ì— ì„¤ì •

import os
import certifi
os.environ['SSL_CERT_FILE'] = certifi.where()

-----------
  ë°°í¬í•˜ê¸°
-----------
https://www.notion.so/7-1c2caf5650aa806ba040f5af5cf08ce4

EC2, S3, IAM ìƒì„±

.env ì‘ì„±í•˜ê¸°
ê°’ì´ë‘ ì£¼ì„ì´ë‘ ê°™ì€ ì¤„ì— ìˆìœ¼ë©´ ì£¼ì„ë„ ê°™ì´ ê°’ìœ¼ë¡œ ì¸ì‹
ê³µë°±ë„ ìˆìœ¼ë©´ ì•ˆë¨
# IAM í‚¤ (ë‹¤ìš´ë°›ì€ csv íŒŒì¼ì—ì„œ í™•ì¸)
S3_ACCESS_KEY=ìƒì„±í•œ ì•¡ì„¸ìŠ¤ í‚¤
S3_SECRET_ACCESS_KEY=ìƒì„±í•œ ë¹„ë°€ ì•¡ì„¸ìŠ¤ í‚¤

# S3 ë²„í‚· ì„¤ì •
S3_STORAGE_BUCKET_NAME=ë³¸ì¸ ë²„í‚· ì´ë¦„
S3_REGION_NAME=ap-northeast-2

django-storages, boto3 ì„¤ì¹˜
poetry add django-storages boto3

- `django-storages`: static, media ê°™ì€ íŒŒì¼ì„ ì €ì¥ì†Œì™€ ì—°ê²°í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
- `boto3`: AWS ì— pythonì„ ì´ìš©í•´ì„œ ì—‘ì„¸ìŠ¤í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

# settings.pyì— ì¶”ê°€

# INSTALLED_APPSì— storages ì¶”ê°€
INSTALLED_APPS = [
  	...
    "storages",
]

# Static, Media URL ìˆ˜ì •
STATIC_URL = f'https://{os.getenv("S3_STORAGE_BUCKET_NAME", "django-mini-project")}.s3.amazonaws.com/static/'
MEDIA_URL = f'https://{os.getenv("S3_STORAGE_BUCKET_NAME", "django-mini-project")}.s3.amazonaws.com/media/'

# STORAGES ì‘ì„±
STORAGES = {
    "default": {
        "BACKEND": "storages.backends.s3.S3Storage",
        "OPTIONS": {
            "access_key": os.getenv("S3_ACCESS_KEY", ""),
            "secret_key": os.getenv("S3_SECRET_ACCESS_KEY", ""),
            "bucket_name": os.getenv("S3_STORAGE_BUCKET_NAME", ""),
            "region_name": os.getenv("S3_REGION_NAME", ""),
            "location": "media",
            "default_acl": "public-read",
        },
    },
    "staticfiles": {
        "BACKEND": "storages.backends.s3.S3Storage",
        "OPTIONS": {
            "access_key": os.getenv("S3_ACCESS_KEY", ""),
            "secret_key": os.getenv("S3_SECRET_ACCESS_KEY", ""),
            "bucket_name": os.getenv("S3_STORAGE_BUCKET_NAME", ""),
            "region_name": os.getenv("S3_REGION_NAME", ""),
            "custom_domain": f'{os.getenv("S3_STORAGE_BUCKET_NAME", "")}.s3.amazonaws.com',
            "location": "static",
            "default_acl": "public-read",
        },
    },
}

--------------------------
# S3ì— static íŒŒì¼ ì—…ë¡œë“œ í•˜ê¸°
--------------------------

python-dotenv ì„¤ì¹˜
poetry add python-dotenv

settings.pyì— ì„¤ì •
from dotenv import load_dotenv
load_dotenv(BASE_DIR / '.env')  # .env íŒŒì¼ ë¡œë“œ

# S3ì— static íŒŒì¼ ì—…ë¡œë“œ
python3 manage.py collectstatic

--------------
RDS ìƒì„± ë° ì„¤ì •
--------------

RDSìƒì„±

.envì— DATABASES ì •ë³´ ì…ë ¥

settings.py(prod.py)ì— ì„¤ì •
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv("DB_NAME"),              # ìƒì„±í•œ DB ì´ë¦„
        'USER': os.getenv("DB_USER"),              # PostgreSQL ì‚¬ìš©ì
        'PASSWORD': os.getenv("DB_PASSWORD"),      # ë¹„ë°€ë²ˆí˜¸
        'HOST': os.getenv("DB_HOST"),              # ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë¯€ë¡œ localhost
        'PORT': os.getenv("DB_PORT", "5432"),      # RDS ì—”ë“œí¬ì¸íŠ¸
    }
}

ec2 ì ‘ì†
ssh -i í‚¤/í˜ì–´/ì €ì¥/ìœ„ì¹˜/mp-key.pem ubuntu@EC2_PUBLIC_IP

--------------------------
# Docker ì„¸íŒ…
--------------------------

ì‘ì„±í•œ Dockerfileì„ í†µí•´ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œ
# docker build -t django .
docker build -f resources/docker/Dockerfile -t wistarback .

ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
# docker run -p 8000:8000 --env-file .env django
docker run -p 8000:8000 --env-file ./envs/local.env wistarback
docker run -p 8000:8000 --env-file ./envs/prod.env wistarback

Dockerfile ìƒì„±
# ë² ì´ìŠ¤ ì´ë¯¸ì§€ (ë³¸ì¸ í”„ë¡œì íŠ¸ì— ë§ëŠ” ë²„ì „ ê¸°ì…)
FROM python:3.12-slim

ENV PYTHONUNBUFFERED 1
ENV PYTHONDONTWRITEBYTECODE 1

# ì¢…ì†ì„± íŒŒì¼ ë³µì‚¬
COPY ./poetry.lock /mini_project/
COPY ./pyproject.toml /mini_project/

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /mini_project

# ì¢…ì†ì„± ì„¤ì¹˜
RUN pip3 install poetry
RUN poetry config virtualenvs.create false
RUN poetry install
RUN poetry add gunicorn

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY ./app /mini_project/app
WORKDIR /mini_project/app


# ì†Œì¼“ íŒŒì¼ ìƒì„± ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
RUN mkdir -p /mini_project && chmod -R 755 /mini_project

# Gunicornì„ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "2"]

ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

scripts/run.sh ìƒì„±
mkdir -p scripts
touch scripts/run.sh

ë„ì»¤ ë¹Œë“œ
docker build -t django .

ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run -p 8000:8000 --env-file .env django

ì‹¤í–‰ì¤‘ì¸ ë„ì»¤ í™•ì¸
docker ps

ì»¨í…Œì´ë„ˆ ì¤‘ì§€
docker stop <ì»¨í…Œì´ë„ˆID ë˜ëŠ” ì´ë¦„>

rds dbì— ì ‘ì†
psql -h <ì—”ë“œí¬ì¸íŠ¸> -U <DB_USER> -d <DB_NAME> -p <PORT>

ê¹ƒ ë¦¬íŒŒì§“í† ë¦¬ íŠ¹ì • ë¸Œëœì¹˜ í´ë¡ 
git clone -b <ë¸Œëœì¹˜ëª…> <ì›ê²©ì£¼ì†Œ>



import hashlib
import hmac

from django.http import HttpResponseForbidden
from django.middleware.csrf import CsrfViewMiddleware

from config.settings import SECRET_KEY


class CustomCSRFMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
        self.exempt_paths = [
            '/api'     # ì˜ˆ: í† í° ë°œê¸‰ ê²½ë¡œ ë“±
        ]
        self.csrf_protected_paths = [
            '/api/users/token/refresh',
            '/api/users/logout'
        ]

    def __call__(self, request):

        path = request.path

        # 1ï¸âƒ£ CSRF ê²€ì‚¬ ì˜ˆì™¸ ì²˜ë¦¬
        if any(path.startswith(exempt) for exempt in self.exempt_paths):
            # 2ï¸âƒ£ íŠ¹ì • ê²½ë¡œëŠ” ë‹¤ì‹œ CSRF ê²€ì‚¬ ìˆ˜í–‰
            if path in self.csrf_protected_paths:
                return CsrfViewMiddleware(self.get_response)(request)
            # ê·¸ ì™¸ APIëŠ” CSRF ë¬´ì‹œ
            return self.get_response(request)

        # ê¸°ë³¸ ì›¹ ìš”ì²­ì€ ê¸°ì¡´ CSRF ì²˜ë¦¬
        return CsrfViewMiddleware(self.get_response)(request)




    def __call__(self, request):

        # ì˜ˆì™¸ ê²½ë¡œëŠ” ê²€ì¦ ì œì™¸
        if request.path in self.exempt_paths:
            return self.get_response(request)

        if request.method in ['POST', 'PUT', 'DELETE']:  # ì¤‘ìš” ìš”ì²­ë§Œ ê²€ì¦
            token = request.headers.get('X-CSRFToken')
            if not self.is_valid(token):
                return HttpResponseForbidden("CSRF ê²€ì¦ ì‹¤íŒ¨")
        return self.get_response(request)
